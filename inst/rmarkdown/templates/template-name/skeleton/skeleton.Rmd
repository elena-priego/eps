---
title: "Experiment"
author: "Elena Priego"
date: `r file.info(knitr::current_input())$ctime`
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
toc-title: "Table of Contents"
#   pdf_document:
#     toc: yes
#   html_document: #bigger size than html_pretty
#     preserve_yaml: false
#     theme: cerulean
#     highlight: tango
#     code_folding: show
#     toc: yes
#     toc_float:
#       collapsed: no
---

```{r setup, include=FALSE}

## global options
options(encoding = "UTF-8")


## packages that will be used
library(eps)
library(here)
library(tidyverse)
library(cowplot)
library(ggthemes)


## paths
eps::path_builder(experiment)


## rmarkdown settings
knitr::opts_chunk$set(
   message = FALSE,
   warning = FALSE,
   fig.align = "center",
   fig.path = file.path(path_data, "fig_"),
   fig.pos = "H"
)


```

## Aim


## Method


## Results

<details><summary>Code to load the data from .csv file generated by flowJo</summary>
```{r}
data("gate_pattern")
data("micecode")
table <- facs_tidytable(file = "Table.xls", 
                             path_data = path_output,
                             animalario_file = experiment, 
                             path_raw = path_raw, 
                             gate_pattern = gate_pattern, 
                             micecode = micecode)
table <-
  table %>% mutate(
    genotype = factor(
      genotype,
      levels = c(
        "VHL-WT  ",
        "VHL-KO  ",
        "VHL-HIF1a-WT  ",
        "VHL-HIF1a-KO  ",
        "VHL-HIF2a-WT  ",
        "VHL-HIF2a-KO  ",
        "VHL-HIF1a-HIF2a-WT  ",
        "VHL-HIF1a-HIF2a-KO  "
      )
    )
  )
  
```
</details>

### Facs analysis

![](.%5Coutput%5Cgate-strategy.png)

```{r}
eps::facs_tree(path_data = path_output)
```


### Statistics

t-test statistic analysis by genotypes

```{r}
tidy_HIF1a_DKO <- table %>% 
  filter(genotype %in% c("VHL-HIF1a-KO  ", "VHL-HIF1a-WT  "))
facs_ttest(tidy_HIF1a_DKO, 
           path_output = path_output,
           file1 = "HIF1a-DKO-t.test.csv", 
           file2 = "HIF1a-DKO-significant-t-test.csv")
```

### Plots

```{r, echo = FALSE}
library(ggthemes)
facs_boxplot <-
  function(table,
           organ.i,
           stat.i,
           marker.i,
           title.i = "",
           x_lab = "",
           y_lab = "",
           y_limit = 0,
           color_values = RColorBrewer::brewer.pal(8, "Paired")[7:8],
           color_breaks = waiver(),
           color_labels = waiver(),
           path_output = path_output,
           w = 10,
           h = 5) {
    table %>%
      filter(organ == organ.i) %>%
      filter(stat == stat.i) %>%
      filter(marker == marker.i) %>%
      ggplot(aes(cell, value, colour = genotype)) +
      geom_boxplot(outlier.shape = NA,
                   fill = "transparent",
                   size = 0.5) +
      geom_point(
        position = position_jitterdodge(jitter.width = 0.3),
        alpha = 0.7,
        size = 3,
        stroke = 0
      ) +
      labs(x = x_lab, y = y_lab, title = title.i) +
      scale_y_continuous() +
      expand_limits(y = y_limit) +
      scale_x_discrete(labels = waiver()) +
      theme_clean(base_family = "sans", base_size = 11) +
      theme(
        strip.text.x = element_blank(),
        legend.position = "right",
        legend.background = element_rect(colour = "transparent",
                                         fill = "transparent"),
        legend.title = element_text(face = "plain", size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(),
        plot.background = element_rect(colour = NA,
                                       fill = "transparent")
      ) +
      scale_color_manual(
        values = color_values,
        name = "Genotype:",
        breaks = color_breaks,
        labels = color_labels
      )
    # ggsave(
    #   file = path_output,
    #   width = w,
    #   height = h,
    #   bg = "transparent"
    # )
  }
```

output plots

```{r, fig.height= 20}
comb <-
   as_tibble(unique(paste(
      table$organ, table$stat, table$marker,
      sep = "_-_"
   ))) %>%
   separate(value,
            into = c("organ", "stat", "marker"),
            sep = "_-_") %>%
   mutate(
      output = here(path_output,paste0(organ, "_", stat, "_", marker, ".png")),
      y_lab = paste0(marker, " (", stat, ")")
   ) %>% as.data.frame()

plots <- 
  apply(comb, 1, function(x)
   facs_boxplot(
      table = table,
      organ.i = x[1],
      stat.i = x[2],
      marker.i = x[3],
      y_lab = x[5],
      title.i = x[1],
      color_values = RColorBrewer::brewer.pal(8, "Paired")[3:8],
      path_output = x[4]
   ))

legend <- cowplot::get_legend(plots[[1]])

cowplot::plot_grid(plots[[1]]+ theme(legend.position='none'), 
          legend, 
          plots[[2]]+ theme(legend.position='none'), 
          plots[[8]]+ theme(legend.position='none'), 
          plots[[3]]+ theme(legend.position='none'), 
          plots[[9]]+ theme(legend.position='none'),
          plots[[4]]+ theme(legend.position='none'),
          plots[[10]]+ theme(legend.position='none'), 
          plots[[5]]+ theme(legend.position='none'), 
          plots[[11]]+ theme(legend.position='none'), 
          plots[[6]]+ theme(legend.position='none'), 
          plots[[12]]+ theme(legend.position='none'),
          plots[[7]]+ theme(legend.position='none'), 
          plots[[13]]+ theme(legend.position='none'), 
          ncol = 2, 
          byrow = TRUE, 
          labels = "AUTO")

```

## Conclusions

